javascript:
  // Needed to activate tooltips.
  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  })
  $(function () {
    $('[data-toggle="popover"]').popover()
  })

  function pad(n) {
    return (n < 10) ? ("0" + n) : n;
  }
  var interval;
  $(document).ready(function(){
    var seconds, minutes, hours, days;

    if (interval != null) {
      clearInterval(interval);
    }
    var timeInfo = $('.time_information').data('time');

    var rubyDate = new Date(timeInfo);
    var javascriptDate = Date.now();
    var offset = rubyDate - javascriptDate;

    var rubyNextDate = new Date(Date.UTC(rubyDate.getUTCFullYear(), rubyDate.getUTCMonth(), rubyDate.getUTCDate() + 1, 0, 0, 0));
    var rubyNextSubmissionDate = new Date(Date.UTC(rubyDate.getUTCFullYear(), rubyDate.getUTCMonth(), rubyDate.getUTCDate() + $('.time_information').data('daysleft'), 0, 0, 0));
    var currentTime = new Date(offset + Date.now());

    var timeToNextDay = rubyNextDate - currentTime;
    var timeToNextSubmissionDate = rubyNextSubmissionDate - currentTime;
    var submitted = $('.time_information').data('submitted')

    if (submitted == -2) {
      $('#TimeDisplay').html(currentTime.toUTCString());
      $('#StreakStatus').html("Please log in to view your streak status.");
      $('#StreakStatus').addClass("streakNeutral");
      $('#NextSubmissionDisplay').css("display", "none")
    } else if (submitted == -1) {
      $('#TimeDisplay').html(currentTime.toUTCString());
      $('#StreakStatus').html("You currently don't have an active streak.");
      $('#StreakStatus').addClass("streakNeutral");
      $('#NextSubmissionDisplay').css("display", "none")
    } else {
      $('#TimeDisplay').html(currentTime.toUTCString());

      seconds = Math.floor(timeToNextSubmissionDate / (1000)) % 60;
      minutes = Math.floor(timeToNextSubmissionDate / (1000*60)) % 60;
      hours = Math.floor(timeToNextSubmissionDate / (1000*60*60)) % 24;
      days = Math.floor(timeToNextSubmissionDate / (1000*60*60*24));

      if (submitted == 0) {
        $('#StreakStatus').html("You must submit soon to protect your streak.<br>");
        $('#StreakStatus').addClass("streakDanger");
        $('#NextSubmissionDisplay').html("Submission Deadline: "+(days ? days+" day(s) " : "")+pad(hours)+":"+pad(minutes)+":"+pad(seconds));
      } else if (submitted == 1) {
        $('#StreakStatus').html("Your streak is safe for now!<br>");
        $('#StreakStatus').addClass("streakSafe");
        $('#NextSubmissionDisplay').html("Next Submission Period: "+(days ? days+" day(s) " : "")+pad(hours)+":"+pad(minutes)+":"+pad(seconds));
      }

    }

    interval = setInterval(function() {
      currentTime = new Date(offset + Date.now());
      timeToNextDay = rubyNextDate - currentTime;
      var pretext;

      if (submitted == -2) {
        $('#TimeDisplay').html(currentTime.toUTCString());
      } else if (submitted == -1) {
        $('#TimeDisplay').html(currentTime.toUTCString());
      } else {
        $('#TimeDisplay').html(currentTime.toUTCString());

        if (submitted == 0) {
          $('#StreakStatus').html("You must submit soon to protect your streak.<br>");
          pretext = "Submission Deadline: ";
        } else if (submitted == 1) {
          $('#StreakStatus').html("Your streak is safe for now!<br>");
          pretext = "Next Submission Period: ";
        }

        timeToNextSubmissionDate = rubyNextSubmissionDate - currentTime;

        if (timeToNextSubmissionDate >= 0) {
          seconds = Math.floor(timeToNextSubmissionDate / (1000)) % 60;
          minutes = Math.floor(timeToNextSubmissionDate / (1000*60)) % 60;
          hours = Math.floor(timeToNextSubmissionDate / (1000*60*60)) % 24;
          days = Math.floor(timeToNextSubmissionDate / (1000*60*60*24));

          $('#NextSubmissionDisplay').html(pretext+(days ? days+" day(s) " : "")+pad(hours)+":"+pad(minutes)+":"+pad(seconds));
        } else {
          $('#NextSubmissionDisplay').html(pretext+"00:00:00");
        }
      }

    }, 1000);

    document.getElementById('CommentableCheckbox').addEventListener('change', function(event) {
      if (event.target.checked) {
        document.getElementById('AllowAnonRow').hidden = false
      } else {
        document.getElementById('AllowAnonRow').hidden = true
      }
    })
  });


  // Paste image data from clipboard into submission
  window.addEventListener('paste', function (event) {
    if ((event.clipboardData || event.originalEvent.clipboardData).files[0] instanceof Blob &&
      (event.clipboardData || event.originalEvent.clipboardData).files[0].type.includes("image")) {
      document.getElementById('drawing').files = (event.clipboardData || event.originalEvent.clipboardData).files
      setDrawingPreview((event.clipboardData || event.originalEvent.clipboardData).files[0])
    }
  }, false);
  
  function setDrawingPreview(blob) {
    
    if (!blob.type.includes("image")) {
      alert("This file doesn't appear to be an image.")
      return;
    }
    
    let reader = new FileReader();
    reader.onload = function (event) {
      document.getElementById('upload-section').classList.add('hidden');
      document.getElementById('video-preview').classList.add('hidden');
      document.getElementById('drawing-preview').classList.remove('hidden');
      document.getElementById('back-button').classList.remove('hidden');
      const imageObjectUrl = document.getElementById('video-preview').currentSrc;
      document.getElementById('video-preview').currentSrc = "";
      URL.revokeObjectURL(imageObjectUrl);
      document.getElementById('drawing-preview').src = event.target.result;
    };
    reader.readAsDataURL(blob);
  }

  function setVideoPreview(blob) {
    
    if (!blob.type.includes("video")) {
      alert("This file doesn't appear to be a video.")
      return;
    }

    document.getElementById('upload-section').classList.add('hidden');
    document.getElementById('drawing-preview').classList.add('hidden');
    document.getElementById('video-preview').classList.remove('hidden');
    document.getElementById('back-button').classList.remove('hidden');
    const newObjectUrl = URL.createObjectURL( blob );
    const oldObjectUrl = document.getElementById('video-preview').currentSrc;
    document.getElementById('video-preview').currentSrc = "";
    URL.revokeObjectURL(oldObjectUrl);
    document.getElementById('video-preview').src = newObjectUrl;
    document.getElementById('video-preview').load();

  }
  
  function resetPreviews() {
    document.getElementById("formElem").reset()
    document.getElementById('upload-section').classList.remove('hidden');
    document.getElementById('drawing-preview').classList.add('hidden');
    document.getElementById('video-preview').classList.add('hidden');
    document.getElementById('back-button').classList.add('hidden');

    const videoObjectUrl = document.getElementById('video-preview').currentSrc;
    document.getElementById('video-preview').currentSrc = "";
    URL.revokeObjectURL(videoObjectUrl);

    const imageObjectUrl = document.getElementById('video-preview').currentSrc;
    document.getElementById('video-preview').currentSrc = "";
    URL.revokeObjectURL(imageObjectUrl);
  }

= form_for @submission, html: { multipart: true, id: "formElem" } do |f|
  .row
    .col-lg-6
      .card
        .card-header
          b
            | New Submission (
            span style="font-weight:600;" bolded
            |  fields are required)

        .card-body
          - if @submission.errors.any?
            #error_explanation
              h3 = "#{pluralize(@submission.errors.count, "error")} prohibited this submission from being posted:"
              ul
                - @submission.errors.full_messages.each do |message|
                  li = message

          | By submitting, you agree to the submission guidelines and content policy as specified
          a href="../help"  here.
          |  Also, be aware that after submitting, <span style="font-weight: 600;">your ability to edit your submission will be
          |  limited after rollover, and deletion will be impossible.</span><br><br>


          #upload-section.form-group.row
            label.label.not-selectable
              span Paste a Drawing
            label.label
              = f.file_field :drawing, style: "overflow: hidden;", oninput: "setDrawingPreview(event.target.files[0])", id: "drawing"
              span Upload a Drawing
            label.label
              = f.file_field :video, style: "overflow: hidden;", oninput: "setVideoPreview(event.target.files[0])", id: "video"
              span Upload a Video
              
          img#drawing-preview.form-group.row class="hidden" src="" alt=""
          video#video-preview.form-group.row class="hidden" controls="true"

          #back-button.form-group.row class="hidden"
            span.btn.btn-primary onclick="resetPreviews()" Go Back
            
          .form-group.row
            .col-3 style="font-weight:600;" = f.label :nsfw_level
            .col-9 = f.select :nsfw_level, options_for_select([['Safe', 1], ['Questionable', 2], ['Explicit', 3]], 1), {}, { class: 'custom-select' }

          .form-group.row
            .col-3 = f.label :title
            .col-9 = f.text_field :title

          .form-group.row
            .col-3 = f.label :description
            .col-9 = f.text_area :description

          .form-group.row
            .col-6 = f.label :time, "Time Spent (in minutes)"
            .col-6 = f.number_field :time, max: 2880

          .form-group.row
            .col-6 = f.label :commentable, "Allow Comments?"
            .col-6 = f.check_box :commentable, checked: "checked", id: "CommentableCheckbox"
          
          #AllowAnonRow.form-group.row
            .col-6 = f.label :allow_anon, "Allow Anonymous Comments?"
            .col-6 = f.check_box :allow_anon

          .form-group.row
            .offset-sm-6.col-sm-6 = f.submit class: 'btn btn-primary', style: "margin-bottom: 0;"

    .col-lg-6
      .card
        .card-body
          - timeinfo = dad_streak_status
          = content_tag :div, class: "time_information", data: {time: Time.now.to_f * 1000, submitted: timeinfo[0], daysleft: timeinfo[1] } do
          span
            i.fa.fa-clock-o
            |  
            span#TimeDisplay
          br
          - current_season = Challenge.current_season
          span
            i class="#{season_to_icon_class(current_season.name)}"
            = " #{current_season.name}: #{pluralize((current_season.end_date - Date.current).to_i, "day")} left."
          br
          br
          span#StreakStatus
          span#NextSubmissionDisplay


      .card
        .card-header
          b Houses
        .card-body
          - if @house_participations
            p.card-text
              | You have earned #{@time / 60} hr and #{@time % 60} min for your house this month
          - else
            p.card-text
              | You are not participating in houses. Consider 
              a href="/houses" joining a house 
              | to track this month's progress.
 

      .card
        .card-header
          b Eligible Challenges

        .card-body
          p.card-text
            | You can submit to the following challenges. All submissions are entered into the Do Art Daily and current seasonal challenge.
            br
            small style="color: grey;"
              b
                | (You can change your frequency without penalty.)

            - frequency_default = current_user.current_dad_frequency || 1
            .form-group.row style="margin-bottom: 0;"
              .col-5 = label_tag :postfrequency, "DAD Post Frequency"
              .col-7 = select_tag :postfrequency, options_for_select([['Daily', 1], ['Every Other Day', 2], ['Every 3 Days', 3], ['Every 4 Days', 4], ['Every 5 Days', 5], ['Every 6 Days', 6], ['Weekly', 7]], frequency_default), { class: 'custom-select' }

            .form-group.row
              .col-5 Seasonal Challenge:
              .col-7 = Challenge.current_season.name
            br

            b Custom Challenges:
            br
            small
              b
                | Remember to double check that you've submitted to all relevant challenges, and that your submission fulfills the conditions required for the challenge.
            - if SiteStatus.first.current_rollover != Time.now.utc.to_date
              br
              b style="color: red;" WARNING! The rollover script has not completed yet. If a challenge you are participating in starts today, it may not currently be selectable.

            - @participations.each do |p|
              - if p.challenge.id != 1 && !p.challenge.seasonal
                .form-group.row
                  .col-3 = label_tag p.challenge_id, "#{p.challenge.name}"
                  .col-3 = check_box_tag p.challenge_id
                  .col-6
